{% extends 'base.html.twig' %}

{% block body %}


    <div class="container-fluid" id="formulaire1">

        <div class="col-lg-4 col-sm-8 col-md-8 mx-auto col-12" id="search-address-wrap">
            <form action="" method="POST" id="form">

                <div class="col-lg-12 col-sm-12 col-md-12 mx-auto col-12">
                    <label for="name"><h2>Recherchez un Nom</h2></label><br>
                    <input style="text-align: center" class="form-control" type="text" id="name" name="name" placeholder="Entrez un nom..." autofocus><br><br>
                </div>

                <div class="col-lg-12 col-sm-12 col-md-12 mx-auto col-12">
                    <label for="adress"><h2>Rechercher une adresse</h2></label><br>
                    <input style="text-align: center" class="form-control" type="text" id="adress" name="adress" placeholder="Entrez une adresse..." autofocus><br><br>
                </div>

                <button id="search-btn" type="submit" class="animated bounceInLeft btn btn-success btn-lg" name="button"><i class="fa fa-search" aria-hidden="true"></i>
                     Rechercher</button>
                <br><br>
            </form>
        </div>
        <br>
        <br>
        <a href="#" class="criteres">
          Autres critères de recherche
        </a>
        <div class="col-lg-6 col-sm-8 col-md-8 mx-auto col-12">
          <form class="searchitems hidden" action="" method="post">
            <div class="form-row">
              <div class="form-group col-md-5">
                <label for="commune">Nom de commune</label>
                <input type="text" name="commune" value="" placeholder="Lyon">
              </div>
              <div class="form-group col-md-5 offset-md-1">
                <label for="nom">Nom du bâtiment</label>
                <input type="text" name="nom" value="" placeholder="nom du bâtiment" >
              </div>
            </div>
            <label for="">Type de bâtiment</label>
            <select class="form-control" name="type">
              <option value="null">Non précisé</option>
              {% for type in typesErp %}
              <option value="{{type.typeactiviteCode}}">{{type.typeactiviteNom}}</option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn-secondary" name="button" value="submit">Recherche avec ces critères</button>
            <!-- <input type="submit" name="submit" value="Recherche avec ces critères"> -->
          </form>
        </div>
        <!-- <button class="btn btn-secondary location-browser map-btn">Autour de moi</button> -->
        <div class="storage" data-lat="45.750000" data-lng="4.850000" data-limit="34" ></div>
        <div class="row">
            <div class="col-12 col-sm-12 col-md-12 col-lg-10 mx-auto">
                <div id="message" class="alert"></div>
            </div>
            <div class="col-10 mx-auto" id="map"></div>
            <br><br>
            <div class="col-11 col-lg-10 mx-auto">
            <table style="margin-top: 20px" class="col-lg-12 table-bordered table-striped" id="result" border='1'>
                <tr>
                </tr>
            </table>
            </div>
        </div>

        <br>

        <p class="alert alert-info col-4 mx-auto">Pour consulter les Précautions d'usage, cliquez <a href=".model-id2" data-toggle="modal">ici</a></p>
        <div tabindex="-1" class="modal fade model-id2" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="text-decoration: underline">Ce site est un site officiel, développé par les services de l’État dans le Rhône.</h2>
                    </div>
                    <div style="text-align: left" class="modal-body">
                        <p><span style="color: green">Il permet </span>de vérifier, pour un établissement recevant du public donné, s’il satisfait à ses obligations réglementaires en termes d’accessibilité aux personnes en situation de handicap par une démarche menée dans le Rhône : <ul><li>soit par une attestation de conformité.</li><li>soit par un agenda d’accessibilité programmée (Ad’AP) validé par le préfet à travers lequel le propriétaire ou l’exploitant s’est engagé à rendre conforme l’établissement dans un délai donné.</li></ul>
                            <span style="font-weight: bold">AUCUN CONTRÔLE SUR PLACE DES ELEMENTS DECLARATIFS CONTENUS DANS CES DOCUMENTS N’EST EXERCE PAR L’ADMINISTRATION.</span>
                        </p>
                        <p><span style="color: red">Il ne permet pas :</span><ul><li>de connaître les établissements entièrement accessibles : un établissement bénéficiant de dérogations pour les aspects ne respectant pas la réglementation est considéré comme conforme ;</li><li>de connaître l’intégralité des établissements du département du Rhône ayant satisfait à leurs obligations : certains ont pu faire l’objet d’un dépôt de documents en préfecture du siège régional ou du siège social.</li></ul></p>
                        <hr style="height: 1px">
                        <p><span style="font-weight: bold">ATTENTION</span> : ce site est en construction. Malgré tous nos efforts, il est possible que certaines fonctionnalités fonctionnent mal et que certaines données soient incomplètes ou aient fait l’objet d’une erreur de saisie. Merci de nous aider à l’améliorer en signalant tout bug ou erreur sur le nom ou l’adresse de l’ERP.</p>

                        <p>Vous êtes gestionnaire ou propriétaire d’un établissement et vous n’avez déposé ni attestation ni  Ad’AP ? Tout savoir pour régulariser votre situation <a href="http://www.rhone.gouv.fr/Politiques-publiques/Amenagement-du-territoire-urbanisme-construction-logement/Accessibilite/Accessibilite-des-Etablissements-Recevant-du-Public-ERP">ici</a>.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>


    <script>

        $(document).ready(function() {

            $('#form').on('submit', function() {
                var result = $('#result')
                var address = document.getElementById('adress').value
                var name = document.getElementById('name').value
                data = address ? address : null
                if(!data) data = name ? name : null
                data = data.split("|")[1]
                $.ajax({
                    method: 'post',
                    url: '',
                    data: {data : data},
                    dataType: 'json',
                    success: function(data) {
                        result.html(data.message)
                        switch (data.status) {
                            case 'ok':
                                result.removeClass('alert-danger')
                                result.addClass('alert-success')
                                break
                            case 'ko':
                                result.removeClass('alert-success')
                                result.addClass('alert-danger')
                                break
                        }
                    },
                    error: function(data) {
                    }
                })
                return false;
            })

            var isBtnClicked = 0;
            $('.criteres').click(function(e){
                e.preventDefault();
                isBtnClicked = !isBtnClicked;
                isBtnClicked ? $('.criteres').html('Réduire') : $('.criteres').html('Autres critères');
                $('.searchitems').toggle();
                clearFields();
            });
          })

        function initMap() {
            var markerArray = [];// Array of google map marker object
            var bounds = new google.maps.LatLngBounds();
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 45.750000, lng: 4.850000},
                zoom: 13
            });

            var input = /** @type {!HTMLInputElement} */(
                document.getElementById('adress'));

            var autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', map);

            document.getElementById('search-btn').addEventListener('click', function() {
                var geocoder = new google.maps.Geocoder();
                geocodeAddress(geocoder, map, markerArray);
            });

            var infowindow = new google.maps.InfoWindow();
            var marker = new google.maps.Marker({
                map: map,
                anchorPoint: new google.maps.Point(0, -29)
            });

            autocomplete.addListener('place_changed', function() {
                infowindow.close();
                marker.setVisible(false);
                var place = autocomplete.getPlace();
                if (!place.geometry) {
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                }
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                }
                marker.setIcon(/** @type {google.maps.Icon} */({
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(35, 35)
                }));
                marker.setPosition(place.geometry.location);
                marker.setVisible(true);

                var address = '';
                if (place.address_components) {
                    address = [
                        (place.address_components[0] && place.address_components[0].short_name || ''),
                        (place.address_components[1] && place.address_components[1].short_name || ''),
                        (place.address_components[2] && place.address_components[2].short_name || '')
                    ].join(' ');
                }

                infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
                infowindow.open(map, marker);

                document.getElementsByClassName('storage')[0].attributes[1].value = marker.position.lat();
                document.getElementsByClassName('storage')[0].attributes[2].value = marker.position.lng();
            });

            // Those are buttons on the google map:
            var aroundMeControlDiv = document.createElement('div');
            var aroundMeControl = new AroundMeControl(aroundMeControlDiv, bounds, map, markerArray);
            aroundMeControlDiv.index = 1;
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(aroundMeControlDiv);

            var aroundThisLocationDiv = document.createElement('div');
            var aroundThisLocationControl = new AroundThisLocationControl(aroundThisLocationDiv, bounds, map, markerArray);
            aroundThisLocationDiv.index = 2;
            map.controls[google.maps.ControlPosition.LEFT_TOP].push(aroundThisLocationDiv);

            var reportAdressControlDiv = document.createElement('div');
            var reportAdressControl = new ReportAdressControl(reportAdressControlDiv);
            reportAdressControlDiv.index = 3;
            map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(reportAdressControlDiv);

            // selector for the form that hold 3 criteria
            $('.searchitems').on('submit', function(event) {
              event.preventDefault();
              var commune = $(this)[0][0].value;
              var nom = $(this)[0][1].value;
              var type = $(this)[0][2].value;
              var result = $('#result');
              var message = $('#message');

              // /!\ CHECK CONDITIONS /!\
              if (type !== "null" && commune.length == 0 && nom.length == 0) {
                message.removeClass('alert-success col-lg-10 mx-auto');
                message.addClass('alert-danger col-lg-10 mx-auto');
                return document.getElementById('message').innerHTML = "Veuillez sélectionner au moins 2 critères.";
              }
              else if (type == "null" && (commune.length == 0 || nom.length == 0)) {
                  message.removeClass('alert-success col-lg-10 mx-auto');
                  message.addClass('alert-danger col-lg-10 mx-auto');
                  return document.getElementById('message').innerHTML = "Veuillez sélectionner au moins 2 critères.";
              }
              message.removeClass('alert-danger col-lg-10 mx-auto');
              document.getElementById('message').innerHTML = "";

              // /!\ END CHECK CONDITION /!\
              for (var i = 0; i < markerArray.length; i++) {
                markerArray[i].setMap(null);
              }
              markerArray = [];
              search_criteria(commune, nom, type, map, bounds, markerArray, message);
            })
        }

        function displayMultiplesMarkers(limit, lat, lng, bounds, map, markerArray) {
            // for (var i = 0; i < markerArray.length; i++) {
            //   markerArray[i].setMap(null);
            // }
            // markerArray = [];
            $.post('/around',{'limit':limit,'lat':lat,'lng':lng}).done(function(data) {

                // numbers need to be in float
                // iterate over data that is rendered by the controller
                for( i = 0; i < ((data.length) -1); i++ ) {
                  // Setup the position of the marker dynamically via it's info
                    var position = new google.maps.LatLng(parseFloat(data[i].listeERP_latitude), parseFloat(data[i].listeERP_longitude));
                    // extends bounds of the map to the position of the marker
                    bounds.extend(position);
                    // create a blue marker everytime
                    var marker = new google.maps.Marker({
                      map: map,
                      position: position,
                      icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                      info: data[i].liste_ERP_nom_erp,
                    });
                    // extends the map to fit bounds so we have every marker displayed on the map
                    map.fitBounds(bounds);
                    //foreach marker, create an event that open a window with the name of the erp (through info)
                    var infowindow = new google.maps.InfoWindow();
                    google.maps.event.addListener(marker, 'click', function () {
                      infowindow.setContent(this.info);
                      infowindow.open(map, this);
                    });
                    markerArray.push(marker);
                }
                //Keep the color for the last one that represent the location from where the user is searching
                var last = data.pop();
                var position = new google.maps.LatLng(parseFloat(last.listeERP_latitude), parseFloat(last.listeERP_longitude));
                bounds.extend(position);
                var marker = new google.maps.Marker({
                  map: map,
                  position: position,
                  info: last.liste_ERP_nom_erp,
                });
                var infowindow = new google.maps.InfoWindow();
                google.maps.event.addListener(marker, 'click', function () {
                  infowindow.setContent(this.info);
                  infowindow.open(map, this);
                });
                // Push every marker into an array so i can reset the array and clear the map for another research
                markerArray.push(marker);
                map.fitBounds(bounds);
            });
        }

        function geocodeAddress(geocoder, resultsMap, markerArray) {
          // If we want to delete all markers before displaying the one geocoded:
          // remove every marker then setup the array to null
          for (var i = 0; i < markerArray.length; i++) {
            markerArray[i].setMap(null);
          }
          markerArray = [];
            var address = document.getElementById('adress').value
            var name = document.getElementById('name').value
            data = address ? address : null
            if(!data) data = name ? name : null
            data = data.split("|")[1]
            geocoder.geocode({'address': data}, function(results, status) {
                if (status === 'OK') {
                    resultsMap.setCenter(results[0].geometry.location);
                    var marker = new google.maps.Marker({
                        map: resultsMap,
                        position: results[0].geometry.location
                    });
                    markerArray.push(marker);
                    // Retrive lat and lng of marker and push it in data attr
                    document.getElementsByClassName('storage')[0].attributes[1].value = marker.position.lat();
                    document.getElementsByClassName('storage')[0].attributes[2].value = marker.position.lng();
                } else {
                }
            });
        }


        function AroundMeControl(aroundMeControlDiv, bounds, map, markerArray) {

          // Set CSS for the aroundmecontrol border.
          var aroundMeUI = document.createElement('div');
          aroundMeUI.style.backgroundColor = '#fff';
          aroundMeUI.style.border = '2px solid #fff';
          aroundMeUI.style.borderRadius = '3px';
          aroundMeUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
          aroundMeUI.style.cursor = 'pointer';
          aroundMeUI.style.marginBottom = '22px';
          aroundMeUI.style.textAlign = 'center';
          aroundMeUI.title = 'Cliquez pour savoir quel(s) erp(s) est(sont) à proximité(s) de vous';
          aroundMeControlDiv.appendChild(aroundMeUI);

          // Set CSS for the control interior.
          var aroundMeText = document.createElement('div');
          aroundMeText.style.color = 'rgb(25,25,25)';
          aroundMeText.style.fontFamily = 'Roboto,Arial,sans-serif';
          aroundMeText.style.fontSize = '12px';
          aroundMeText.style.lineHeight = '30px';
          aroundMeText.style.paddingLeft = '5px';
          aroundMeText.style.paddingRight = '5px';
          aroundMeText.innerHTML = 'Autour de moi';
          aroundMeUI.appendChild(aroundMeText);

          // Setup the click event listeners: locate the user
          aroundMeUI.addEventListener('click', function() {
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                // get current position
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                var limit = parseInt($('.storage')[0].attributes[3].value);
                for (var i = 0; i < markerArray.length; i++) {
                  markerArray[i].setMap(null);
                }
                markerArray = [];
                bounds = new google.maps.LatLngBounds();
                displayMultiplesMarkers(limit, lat, lng, bounds, map, markerArray);
              }, function() {
                handleLocationError(true, map, map.getCenter());
              });
              } else {
              // Browser doesn't support Geolocation
              handleLocationError(false, map, map.getCenter());
              //displayMultiplesMarkers(limit, lat, lng, bounds, map, markerArray);
              }
          });

        }

        function AroundThisLocationControl(aroundThisLocationDiv, bounds, map, markerArray) {

          // Set CSS for the control border.
          var aroundThisLocationUI = document.createElement('div');
          aroundThisLocationUI.style.backgroundColor = '#fff';
          aroundThisLocationUI.style.border = '2px solid #fff';
          aroundThisLocationUI.style.borderRadius = '3px';
          aroundThisLocationUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
          aroundThisLocationUI.style.cursor = 'pointer';
          aroundThisLocationUI.style.marginBottom = '22px';
          aroundThisLocationUI.style.textAlign = 'center';
          aroundThisLocationUI.title = 'Cliquez pour savoir quel(s) erp(s) est(sont) à proximité(s) de ce point';
          aroundThisLocationDiv.appendChild(aroundThisLocationUI);

          // Set CSS for the control interior.
          var aroundThisLocationText = document.createElement('div');
          aroundThisLocationText.style.color = 'rgb(25,25,25)';
          aroundThisLocationText.style.fontFamily = 'Roboto,Arial,sans-serif';
          aroundThisLocationText.style.fontSize = '12px';
          aroundThisLocationText.style.lineHeight = '30px';
          aroundThisLocationText.style.paddingLeft = '5px';
          aroundThisLocationText.style.paddingRight = '5px';
          aroundThisLocationText.innerHTML = 'Autour de ce point';
          aroundThisLocationUI.appendChild(aroundThisLocationText);

          // Setup the click event listeners: geolocate the user
          aroundThisLocationUI.addEventListener('click', function() {
            var lat = parseFloat($('.storage')[0].attributes[1].value);
            var lng = parseFloat($('.storage')[0].attributes[2].value);
            var limit = parseInt($('.storage')[0].attributes[3].value);
            for (var i = 0; i < markerArray.length; i++) {
              markerArray[i].setMap(null);
            }
            markerArray = [];
            bounds = new google.maps.LatLngBounds();
            displayMultiplesMarkers(limit, lat, lng, bounds, map, markerArray);
          });

        }

        function ReportAdressControl(reportAdressControlDiv) {

          var reportAdressUI = document.createElement('div');
          reportAdressUI.style.backgroundColor = '#fff';
          reportAdressUI.style.border = '2px solid #fff';
          reportAdressUI.style.borderRadius = '3px';
          reportAdressUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
          reportAdressUI.style.cursor = 'pointer';
          reportAdressUI.style.marginBottom = '22px';
          reportAdressUI.style.textAlign = 'center';
          reportAdressUI.title = 'Cliquez pour savoir quel(s) erp(s) est(sont) à proximité(s) de ce point';
          reportAdressControlDiv.appendChild(reportAdressUI);

          var reportAdressText = document.createElement('div');
          reportAdressText.style.color = 'rgb(25,25,25)';
          reportAdressText.style.fontFamily = 'Roboto,Arial,sans-serif';
          reportAdressText.style.fontSize = '12px';
          reportAdressText.style.lineHeight = '30px';
          reportAdressText.style.paddingLeft = '5px';
          reportAdressText.style.paddingRight = '5px';
          reportAdressText.innerHTML = 'Signalez une adresse';
          reportAdressUI.appendChild(reportAdressText);

          reportAdressUI.addEventListener('click', function() {
            window.location = "/report/new";
          });

        }

        function search_criteria(commune, nom, type, map, bounds, markerArray, message) {
          $.post('/search_list',{'commune':commune,'nom':nom, 'type':type}).done(function(data) {
            //debugger;
            document.getElementById('result').innerHTML = "";
            var result = '';
            for (var i = 0; i < data.length; i++) {
              result += '<tr><td>' + data[i].listeErpNomErp + ' | ' + data[i].listeerpNomCommune + '</td></tr>';

              // If the erp has latitude and long in ddb we take it, otherise we don't display it on the map
              if (parseFloat(data[i].listeerpLatitude) != 0) {
                var position = new google.maps.LatLng(parseFloat(data[i].listeerpLatitude), parseFloat(data[i].listeerpLongitude));

                // // extends bounds of the map to the position of the marker
                bounds.extend(position);
                //
                var marker = new google.maps.Marker({
                  map: map,
                  position: position,
                  //icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                  info: data[i].listeErpNomErp,
                });
                // // extends the map to fit bounds so we have every marker displayed on the map
                map.fitBounds(bounds);
                // //foreach marker, create an event that open a window with the name of the erp (through info)
                var infowindow = new google.maps.InfoWindow();
                google.maps.event.addListener(marker, 'click', function () {
                  infowindow.setContent(this.info);
                  infowindow.open(map, this);
                });
                markerArray.push(marker);
              }
            }
          //debugger;
          message.removeClass('alert-danger')
          message.addClass('alert-success col-lg-10 mx-auto')
          document.getElementById('message').innerHTML = data.length + " établissements correspondant à votre recherche."
          $('#result').append(result);

          })
        }
    </script>
{% endblock %}
